<link rel="import" href="../@polymer/polymer/polymer.html">

<dom-module id="express-app">
    <script>
        class ExpressAppComponent {

            beforeRegister() {
                this.is = 'express-app';
                this.properties = {
                    port: {
                        type: Number
                    },
                    hostname: {
                        type: String
                    },
                    backlog: {
                        type: Number
                    },
                    callback: {
                        type: Object
                    }
                };
            }

            ready() {
                const express = require('express');
                const app = express();
                const port = this.port;
                const hostname = this.hostname;
                const backlog = this.backlog;
                const defaultCallback = () => {
                    console.log(`express app listening on port: ${port}`);
                };
                const callback = this.callback || defaultCallback;

                app.listen(port, hostname, backlog, callback);
                this.expressBundle = {
                    app,
                    express
                };
            }

            attached() {
                const children = Array.prototype.slice.call(this.childNodes);
                children.forEach((child) => {
                    !child.expressBundle && (child.expressBundle = this.expressBundle);
                });
            }

            detached() {}
            attributeChanged() {}
        }

        Polymer(ExpressAppComponent);

        window.ExpressParentBehavior = {
            properties: {
                expressBundle: { //set by the parent element imperatively
                    type: Object,
                    observer: 'init'
                }
            },
            init: function() {
                const app = this.expressBundle.app;
                const router = this.expressBundle.router;

                const children = Array.prototype.slice.call(this.childNodes);
                children.forEach((child) => {
                    if (!child.expressBundle) {
                        child.expressBundle = {
                            app: app,
                            router: router
                        };
                    }
                });
            }
        };
    </script>
</dom-module>
