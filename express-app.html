<link rel="import" href="../@polymer/polymer/polymer.html">

<dom-module id="express-app">
    <script>
        class ExpressAppComponent {

            beforeRegister() {
                this.is = 'express-app';
                this.properties = {
                    port: {
                        type: Number,
                        observer: 'prepareApp'
                    },
                    hostname: {
                        type: String
                    },
                    backlog: {
                        type: Number
                    },
                    callback: {
                        type: Object
                    }
                };
            }

            prepareApp() {
                const initApp = () => {
                    const express = require('express');
                    const app = express();
                    const defaultCallback = () => {
                        console.log(`express app listening on port: ${this.port}`);
                    };
                    const theCallback = this.callback || defaultCallback;

                    console.log(this.port);
                    console.log(this.hostname);
                    console.log(this.backlog);
                    console.log(theCallback);

                    const server = app.listen(this.port, this.hostname, this.backlog, theCallback);

                    this.expressBundle = {
                        app,
                        express,
                        server
                    };
                };

                const run = () => {
                    const server = this.expressBundle ? this.expressBundle.server : undefined;

                    const closeTCPConnection = () => {
                        server.close(() => {
                            setTimeout(() => { //TODO I need this timeout to get Express to hook up the routes correctly, understand exactly why
                                initApp();
                                this.initChildren();
                            });
                        });
                    };

                    if (server) {
                        if (server.listening) {
                            closeTCPConnection();
                        }
                        else {
                            console.log(server);
                            server.on('listening', () => {
                                console.log('listening event fired')
                                //closeTCPConnection();
                            });
                        }
                    }
                    else {
                        setTimeout(() => { //this timeout allows all properties to be set in the host element
                            initApp();
                            this.initChildren();
                        });
                    }
                };

                run();
            }

            initChildren() {
                const children = Array.prototype.slice.call(this.childNodes);
                children.forEach((child) => {
                    child.expressBundle = this.expressBundle
                });
            }
        }

        Polymer(ExpressAppComponent);

        window.ExpressParentBehavior = {
            properties: {
                expressBundle: { //set by the parent element imperatively
                    type: Object,
                    observer: 'init'
                }
            },
            init: function() {
                const app = this.expressBundle.app;
                const router = this.expressBundle.router;

                const children = Array.prototype.slice.call(this.childNodes);
                children.forEach((child) => {
                    child.expressBundle = {
                        app: app,
                        router: router
                    };
                });
            }
        };
    </script>
</dom-module>
