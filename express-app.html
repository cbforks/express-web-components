<script>
    class ExpressAppComponent extends HTMLElement {

        constructor() {
            super();

            this._port = null;
            this._path = null;
            this._hostname = null;
            this._backlog = null;
            this._callback = null;
        }

        static get observedAttributes() {
            return [
                'port',
                'path',
                'hostname',
                'backlog'
            ];
        }

        attributeChangedCallback(name, oldValue, newValue) {
            switch (name) {
                case 'port': {
                    this.port = newValue;
                    break;
                }
                case 'path': {
                    this.path = newValue;
                    break;
                }
                case 'hostname': {
                    this.hostname = newValue;
                    break;
                }
                case 'backlog': {
                    this.backlog = newValue;
                    break;
                }
            }
        }

        set port(val) {
            this._port = val;
            this.listen();
        }

        set path(val) {
            this._path = val;
        }

        set hostname(val) {
            this._hostname = val;
        }

        set backlog(val) {
            this._backlog = val;
        }

        set callback(val) {
            this._callback = val;
        }

        connectedCallback() {
            this.prepareApp();
        }

        prepareApp() {
            if (!this.express && !this.app) {
                this.express = require('express');
                this.app = this.express();
            }
        }

        listen() {
            this.prepareApp();
            setTimeout(() => { //TODO this probably is not necessary. This timeout was thought to allow all properties to be set in the host element
                const defaultCallback = () => {
                    console.log(`express app listening on port: ${this._port}`);
                };
                const theCallback = this._callback || defaultCallback;

                this.app.listen(this._port, this._hostname, this._backlog, theCallback);

                this.initChildren();
            });
        }

        init(app, express, router, route) {
            if (this._path) {
                app.use(this._path, this.app);
            }
            else {
                app.use(this.app);
            }

            this.initChildren();
        }

        initChildren() {
            const children = Array.from(this.children);
            children.forEach((child) => {

                //TODO this code is repeated exactly in express-router.html and express-route.html
                if (!child.init) {
                    const init = function(app, express, router, route) {

                        const children = Array.from(this.children);
                        children.forEach((child) => {
                            if (!child.init) {
                                child.init = init;
                            }

                            child.init(app, express, router, route);
                        });
                    };

                    child.init = init;
                }
                //TODO this code is repeated exactly in express-router.html and express-route.html

                child.init(this.app, this.express);
            });
        }
    }

    window.customElements.define('express-app', ExpressApp);
</script>
